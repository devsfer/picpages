<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFippTUHmMjLDnxC3teVgv3QoZLA7e2po",
    authDomain: "sso-authentication-d474d.firebaseapp.com",
    projectId: "sso-authentication-d474d",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Try to use token from localStorage
  const token = localStorage.getItem("picpagesSession");

  if (!token) {
    window.location.href = "https://secure.its.ordunafoundation.org/external/picpages/login";
  } else {
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Already authenticated, show profile or directory
        document.getElementById("directory-section").style.display = "block";
        document.getElementById("status").textContent = `Logged in as ${user.email}`;
      } else {
        // Try to authenticate using the ID token
        auth.signInWithCustomToken(token)
          .then(() => {
            document.getElementById("directory-section").style.display = "block";
            document.getElementById("status").textContent = `Logged in as ${auth.currentUser.email}`;
          })
          .catch(() => {
            localStorage.removeItem("picpagesSession");
            window.location.href = "https://secure.its.ordunafoundation.org/external/picpages/login";
          });
      }
    });
  }
</script>
